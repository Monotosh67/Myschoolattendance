{% extends "base.html" %}

{% block title %}Assign Teacher - Dewra High School{% endblock %}

{% block extra_css %}
<style>
.assign-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.page-header {
    margin-bottom: 30px;
}

.page-header h1 {
    font-size: 2rem;
    color: var(--light);
    margin-bottom: 5px;
}

.page-header p {
    color: var(--gray);
    font-size: 1rem;
}

.back-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: var(--primary);
    text-decoration: none;
    font-weight: 500;
    margin-top: 10px;
}

.back-link:hover {
    text-decoration: underline;
}

.teacher-info {
    background: linear-gradient(135deg, rgba(20, 25, 50, 0.9), rgba(30, 35, 60, 0.9));
    border-radius: 15px;
    padding: 25px;
    border: 2px solid var(--card-border);
    margin-bottom: 30px;
}

.teacher-header {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 20px;
}

.teacher-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    border: 3px solid var(--primary);
    overflow: hidden;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    flex-shrink: 0;
}

.teacher-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.default-avatar {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 2rem;
}

.teacher-details h3 {
    font-size: 1.5rem;
    color: var(--light);
    margin-bottom: 5px;
}

.teacher-details p {
    color: var(--gray);
    font-size: 0.95rem;
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 3px;
}

.assignment-form {
    background: linear-gradient(135deg, rgba(20, 25, 50, 0.9), rgba(30, 35, 60, 0.9));
    border-radius: 20px;
    padding: 30px;
    border: 2px solid var(--card-border);
}

.section-title {
    font-size: 1.3rem;
    color: var(--light);
    margin-bottom: 25px;
    display: flex;
    align-items: center;
    gap: 10px;
    padding-bottom: 15px;
    border-bottom: 2px solid var(--card-border);
}

.section-title i {
    color: var(--primary);
}

.classes-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 25px;
    margin-bottom: 40px;
}

.class-card {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 15px;
    padding: 25px;
    border: 2px solid var(--card-border);
    transition: all 0.3s;
}

.class-card:hover {
    border-color: var(--primary);
    transform: translateY(-3px);
}

.class-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
}

.class-icon {
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.3rem;
    flex-shrink: 0;
}

.class-info h4 {
    font-size: 1.3rem;
    color: var(--light);
    margin-bottom: 5px;
}

.class-info p {
    color: var(--gray);
    font-size: 0.9rem;
}

.sections-list {
    margin-top: 15px;
}

.section-item {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
    padding: 12px;
    background: rgba(0, 212, 255, 0.05);
    border-radius: 10px;
    border: 1px solid var(--card-border);
}

.section-checkbox {
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1;
}

.checkbox-input {
    width: 18px;
    height: 18px;
    border: 2px solid var(--card-border);
    border-radius: 4px;
    cursor: pointer;
    position: relative;
    transition: all 0.3s;
}

.checkbox-input.checked {
    background: var(--primary);
    border-color: var(--primary);
}

.checkbox-input.checked::after {
    content: 'âœ“';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 12px;
    font-weight: bold;
}

.checkbox-label {
    color: var(--light);
    font-weight: 500;
    font-size: 0.95rem;
    cursor: pointer;
    user-select: none;
    flex: 1;
}

.section-count {
    color: var(--gray);
    font-size: 0.85rem;
}

.subjects-list {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid var(--card-border);
}

.subjects-list h5 {
    color: var(--light);
    font-size: 1rem;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.subjects-list h5 i {
    color: var(--primary);
}

.subject-item {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
    padding: 10px;
    background: rgba(0, 0, 0, 0.1);
    border-radius: 8px;
}

.subject-checkbox {
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1;
}

.subject-label {
    color: var(--light);
    font-size: 0.9rem;
    cursor: pointer;
    user-select: none;
    flex: 1;
}

.subject-code {
    color: var(--gray);
    font-size: 0.8rem;
    background: rgba(0, 212, 255, 0.1);
    padding: 2px 8px;
    border-radius: 4px;
}

.form-actions {
    display: flex;
    gap: 15px;
    justify-content: flex-end;
    padding-top: 30px;
    margin-top: 30px;
    border-top: 2px solid var(--card-border);
}

.btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    border-radius: 12px;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.3s;
    border: 2px solid transparent;
    font-family: inherit;
    cursor: pointer;
    font-size: 1rem;
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    border: none;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 212, 255, 0.4);
}

.btn-outline {
    background: transparent;
    border-color: var(--card-border);
    color: var(--light);
}

.btn-outline:hover {
    background: rgba(0, 212, 255, 0.1);
    transform: translateY(-2px);
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(10, 14, 39, 0.95);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    flex-direction: column;
}

.loading-overlay.active {
    display: flex;
}

.loader {
    width: 60px;
    height: 60px;
    border: 4px solid rgba(0, 212, 255, 0.2);
    border-top: 4px solid var(--primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

.loader-text {
    margin-top: 20px;
    color: var(--primary);
    font-weight: 500;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--gray);
    grid-column: 1 / -1;
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 15px;
    color: var(--primary);
    opacity: 0.5;
}

.empty-state h4 {
    color: var(--light);
    margin-bottom: 10px;
    font-size: 1.2rem;
}

.empty-state p {
    margin-bottom: 20px;
    font-size: 0.95rem;
}

@media (max-width: 768px) {
    .assign-container {
        padding: 15px;
    }
    
    .page-header h1 {
        font-size: 1.7rem;
    }
    
    .teacher-header {
        flex-direction: column;
        text-align: center;
    }
    
    .classes-grid {
        grid-template-columns: 1fr;
    }
    
    .class-card {
        padding: 20px;
    }
    
    .form-actions {
        flex-direction: column;
    }
    
    .btn {
        width: 100%;
        justify-content: center;
    }
}

@media (max-width: 480px) {
    .assignment-form {
        padding: 20px;
    }
    
    .section-title {
        font-size: 1.1rem;
    }
    
    .class-info h4 {
        font-size: 1.1rem;
    }
    
    .section-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
    
    .section-checkbox {
        width: 100%;
    }
    
    .subject-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="assign-container">
    <div class="page-header">
        <h1>Assign Classes & Subjects</h1>
        <p>Assign classes, sections, and subjects to teacher: {{ teacher.username }}</p>
        <a href="{{ url_for('manage_teachers') }}" class="back-link">
            <i class="fas fa-arrow-left"></i> Back to Teachers
        </a>
    </div>
    
    <div class="teacher-info">
        <div class="teacher-header">
            <div class="teacher-avatar">
                {% if teacher.profile_image %}
                <img src="{{ url_for('static', filename=teacher.profile_image) }}" 
                     alt="{{ teacher.username }}"
                     onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\\'default-avatar\\'><i class=\\"fas fa-user-tie\\"></i></div>';">
                {% else %}
                <div class="default-avatar">
                    <i class="fas fa-user-tie"></i>
                </div>
                {% endif %}
            </div>
            <div class="teacher-details">
                <h3>{{ teacher.username }}</h3>
                <p><i class="fas fa-envelope"></i> {{ teacher.email }}</p>
                <p><i class="fas fa-phone"></i> {{ teacher.phone or 'Not set' }}</p>
                <p><i class="fas fa-id-card"></i> Teacher ID: T-{{ teacher.id }}</p>
            </div>
        </div>
        
        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
            <div style="background: rgba(0, 212, 255, 0.1); padding: 10px 15px; border-radius: 8px;">
                <span style="color: var(--gray); font-size: 0.9rem;">Current Classes:</span>
                <span style="color: var(--light); font-weight: 500; margin-left: 8px;">
                    {% set assigned_class_count = namespace(total=0) %}
                    {% for class_name, sections in assigned_classes.items() %}
                        {% for section in sections %}
                            {% set assigned_class_count.total = assigned_class_count.total + 1 %}
                        {% endfor %}
                    {% endfor %}
                    {{ assigned_class_count.total }} classes
                </span>
            </div>
            
            <div style="background: rgba(0, 212, 255, 0.1); padding: 10px 15px; border-radius: 8px;">
                <span style="color: var(--gray); font-size: 0.9rem;">Current Subjects:</span>
                <span style="color: var(--light); font-weight: 500; margin-left: 8px;">
                    {% set assigned_subject_count = namespace(total=0) %}
                    {% for class_name, subject_ids in assigned_subjects.items() %}
                        {% set assigned_subject_count.total = assigned_subject_count.total + subject_ids|length %}
                    {% endfor %}
                    {{ assigned_subject_count.total }} subjects
                </span>
            </div>
        </div>
    </div>
    
    <form method="POST" action="{{ url_for('manage_teachers') }}" class="assignment-form" id="assignmentForm">
        <input type="hidden" name="action" value="assign">
        <input type="hidden" name="teacher_id" value="{{ teacher.id }}">
        
        <h3 class="section-title">
            <i class="fas fa-chalkboard"></i> Select Classes & Sections
        </h3>
        
        {% if classes %}
        <div class="classes-grid">
            {% for class_obj in classes %}
            <div class="class-card">
                <div class="class-header">
                    <div class="class-icon">
                        <i class="fas fa-chalkboard-teacher"></i>
                    </div>
                    <div class="class-info">
                        <h4>Class {{ class_obj.name }}</h4>
                        <p>{{ class_obj.description or '' }}</p>
                    </div>
                </div>
                
                {% set sections = json.loads(class_obj.sections) %}
                {% if sections %}
                <div class="sections-list">
                    {% for section in sections %}
                    <div class="section-item">
                        <div class="section-checkbox">
                            <div class="checkbox-input {% if class_obj.name in assigned_classes and section in assigned_classes[class_obj.name] %}checked{% endif %}" 
                                 data-type="class"
                                 data-class="{{ class_obj.name }}"
                                 data-section="{{ section }}"></div>
                            <label class="checkbox-label">Section {{ section }}</label>
                            <input type="checkbox" 
                                   name="class_{{ class_obj.name }}_{{ section }}" 
                                   value="1"
                                   class="hidden-checkbox"
                                   {% if class_obj.name in assigned_classes and section in assigned_classes[class_obj.name] %}checked{% endif %}>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <div class="subjects-list">
                    <h5>
                        <i class="fas fa-book"></i> Assign Subjects for Class {{ class_obj.name }}
                    </h5>
                    
                    {% if subjects %}
                    {% for subject in subjects %}
                    <div class="subject-item">
                        <div class="subject-checkbox">
                            <div class="checkbox-input {% if class_obj.name in assigned_subjects and subject.id|string in assigned_subjects[class_obj.name] %}checked{% endif %}" 
                                 data-type="subject"
                                 data-class="{{ class_obj.name }}"
                                 data-subject="{{ subject.id }}"></div>
                            <label class="subject-label">{{ subject.name }}</label>
                            <span class="subject-code">{{ subject.code or 'No code' }}</span>
                            <input type="checkbox" 
                                   name="subject_{{ class_obj.name }}_{{ subject.id }}" 
                                   value="1"
                                   class="hidden-checkbox"
                                   {% if class_obj.name in assigned_subjects and subject.id|string in assigned_subjects[class_obj.name] %}checked{% endif %}>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div style="color: var(--gray); font-size: 0.9rem; text-align: center; padding: 10px;">
                        <i class="fas fa-exclamation-circle"></i> No subjects available
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <div style="color: var(--gray); font-size: 0.9rem; text-align: center; padding: 20px;">
                    <i class="fas fa-exclamation-circle"></i> No sections defined for this class
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-chalkboard"></i>
            <h4>No Classes Available</h4>
            <p>
                No classes have been created in the system yet.
                Please create classes first before assigning them to teachers.
            </p>
            <a href="{{ url_for('manage_classes') }}" class="btn btn-primary">
                <i class="fas fa-plus-circle"></i> Create Classes
            </a>
        </div>
        {% endif %}
        
        <div class="form-actions">
            <a href="{{ url_for('manage_teachers') }}" class="btn btn-outline">
                <i class="fas fa-times"></i> Cancel
            </a>
            <button type="submit" class="btn btn-primary" id="saveAssignments">
                <i class="fas fa-save"></i> Save Assignments
            </button>
        </div>
    </form>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loader"></div>
    <div class="loader-text">Saving Assignments...</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const loadingOverlay = document.getElementById('loadingOverlay');
    const saveButton = document.getElementById('saveAssignments');
    const assignmentForm = document.getElementById('assignmentForm');
    
    // Handle checkbox clicks
    document.querySelectorAll('.checkbox-input').forEach(checkbox => {
        checkbox.addEventListener('click', function() {
            const type = this.dataset.type;
            const className = this.dataset.class;
            const section = this.dataset.section;
            const subject = this.dataset.subject;
            
            // Toggle checked state
            this.classList.toggle('checked');
            
            // Find corresponding hidden checkbox
            let hiddenCheckbox;
            if (type === 'class') {
                hiddenCheckbox = document.querySelector(`input[name="class_${className}_${section}"]`);
            } else if (type === 'subject') {
                hiddenCheckbox = document.querySelector(`input[name="subject_${className}_${subject}"]`);
            }
            
            if (hiddenCheckbox) {
                hiddenCheckbox.checked = this.classList.contains('checked');
            }
            
            // If it's a class checkbox, enable/disable subjects for that class
            if (type === 'class' && section) {
                const subjectCheckboxes = document.querySelectorAll(`.checkbox-input[data-type="subject"][data-class="${className}"]`);
                const hiddenSubjectCheckboxes = document.querySelectorAll(`input[name^="subject_${className}_"]`);
                
                if (this.classList.contains('checked')) {
                    // Enable subject checkboxes
                    subjectCheckboxes.forEach(cb => {
                        cb.style.opacity = '1';
                        cb.style.pointerEvents = 'auto';
                    });
                    hiddenSubjectCheckboxes.forEach(cb => {
                        cb.disabled = false;
                    });
                } else {
                    // Disable and uncheck subject checkboxes
                    subjectCheckboxes.forEach(cb => {
                        cb.classList.remove('checked');
                        cb.style.opacity = '0.5';
                        cb.style.pointerEvents = 'none';
                    });
                    hiddenSubjectCheckboxes.forEach(cb => {
                        cb.checked = false;
                        cb.disabled = true;
                    });
                }
            }
        });
    });
    
    // Initialize subject checkboxes based on class selection
    document.querySelectorAll('.checkbox-input[data-type="class"]').forEach(checkbox => {
        const className = checkbox.dataset.class;
        const isChecked = checkbox.classList.contains('checked');
        const subjectCheckboxes = document.querySelectorAll(`.checkbox-input[data-type="subject"][data-class="${className}"]`);
        const hiddenSubjectCheckboxes = document.querySelectorAll(`input[name^="subject_${className}_"]`);
        
        if (!isChecked) {
            subjectCheckboxes.forEach(cb => {
                cb.style.opacity = '0.5';
                cb.style.pointerEvents = 'none';
            });
            hiddenSubjectCheckboxes.forEach(cb => {
                cb.disabled = true;
            });
        }
    });
    
    // Form submission
    assignmentForm.addEventListener('submit', function(e) {
        // Show loading overlay
        loadingOverlay.classList.add('active');
        
        // Change button text
        if (saveButton) {
            const originalHTML = saveButton.innerHTML;
            saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            saveButton.disabled = true;
            
            // Revert after 5 seconds if form hasn't submitted
            setTimeout(() => {
                saveButton.innerHTML = originalHTML;
                saveButton.disabled = false;
                loadingOverlay.classList.remove('active');
            }, 5000);
        }
    });
    
    // Add animation to class cards
    const classCards = document.querySelectorAll('.class-card');
    classCards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            card.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });
    
    // Select all/none functionality (optional enhancement)
    const selectAllBtn = document.createElement('button');
    selectAllBtn.type = 'button';
    selectAllBtn.className = 'btn btn-outline btn-sm';
    selectAllBtn.innerHTML = '<i class="fas fa-check-double"></i> Select All';
    selectAllBtn.style.marginBottom = '20px';
    
    selectAllBtn.addEventListener('click', function() {
        const checkboxes = document.querySelectorAll('.checkbox-input');
        const isAllSelected = Array.from(checkboxes).every(cb => cb.classList.contains('checked'));
        
        checkboxes.forEach(cb => {
            if (isAllSelected) {
                cb.classList.remove('checked');
            } else {
                cb.classList.add('checked');
            }
            
            // Trigger click to update hidden checkboxes
            cb.click();
        });
        
        this.innerHTML = isAllSelected ? 
            '<i class="fas fa-check-double"></i> Select All' : 
            '<i class="fas fa-times"></i> Deselect All';
    });
    
    // Insert select all button before the first section title
    const firstSection = document.querySelector('.section-title');
    if (firstSection) {
        firstSection.parentNode.insertBefore(selectAllBtn, firstSection.nextSibling);
    }
});
</script>

<style>
.hidden-checkbox {
    display: none;
}
</style>
{% endblock %}
