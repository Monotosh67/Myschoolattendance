{% extends "base.html" %}

{% block title %}Take Attendance - Dewra High School{% endblock %}

{% block extra_css %}
<style>
.attendance-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.attendance-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    flex-wrap: wrap;
    gap: 20px;
}

.header-left h1 {
    font-size: 2rem;
    color: var(--light);
    margin-bottom: 5px;
}

.header-left p {
    color: var(--gray);
    font-size: 1rem;
}

.motivational-message {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 20px;
    background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(0, 255, 136, 0.1));
    border-radius: 12px;
    border: 2px solid var(--card-border);
    color: var(--primary);
    font-weight: 500;
    font-size: 0.95rem;
}

.attendance-form {
    background: linear-gradient(135deg, rgba(20, 25, 50, 0.9), rgba(30, 35, 60, 0.9));
    border-radius: 20px;
    padding: 30px;
    border: 2px solid var(--card-border);
    margin-bottom: 30px;
}

.form-section {
    margin-bottom: 30px;
}

.section-title {
    font-size: 1.3rem;
    color: var(--light);
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
    padding-bottom: 10px;
    border-bottom: 2px solid var(--card-border);
}

.section-title i {
    color: var(--primary);
}

.form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.form-label {
    color: var(--light);
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.95rem;
}

.form-label i {
    color: var(--primary);
    width: 16px;
}

.form-control {
    background: rgba(0, 0, 0, 0.2);
    border: 2px solid var(--card-border);
    border-radius: 12px;
    padding: 14px 16px;
    color: var(--light);
    font-size: 1rem;
    transition: all 0.3s;
    font-family: inherit;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%2300d4ff' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 16px center;
    background-size: 16px;
    padding-right: 40px;
}

.form-control:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
}

.form-control option {
    background: var(--darker);
    color: var(--light);
}

.btn-primary {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 14px 28px;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    border: none;
    border-radius: 12px;
    color: white;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    text-decoration: none;
}

.btn-primary:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 212, 255, 0.4);
}

.btn-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.btn-secondary {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    background: rgba(0, 212, 255, 0.1);
    border: 2px solid var(--card-border);
    border-radius: 12px;
    color: var(--light);
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    text-decoration: none;
}

.btn-secondary:hover {
    border-color: var(--primary);
    background: rgba(0, 212, 255, 0.2);
}

.form-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 20px;
    border-top: 2px solid var(--card-border);
    margin-top: 30px;
}

.students-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
    max-height: 500px;
    overflow-y: auto;
    padding: 10px;
    margin-bottom: 20px;
}

.student-card {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 12px;
    border: 2px solid var(--card-border);
    transition: all 0.3s;
}

.student-card:hover {
    border-color: var(--primary);
    transform: translateX(5px);
}

.student-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    border: 2px solid var(--primary);
    overflow: hidden;
    flex-shrink: 0;
}

.student-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.student-avatar .default-avatar {
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.2rem;
}

.student-info {
    flex: 1;
}

.student-name {
    color: var(--light);
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 3px;
}

.student-details {
    color: var(--gray);
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 15px;
}

.student-details span {
    display: flex;
    align-items: center;
    gap: 5px;
}

.attendance-actions {
    display: flex;
    gap: 10px;
    align-items: center;
}

.status-btn {
    padding: 8px 20px;
    border-radius: 8px;
    border: 2px solid transparent;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 0.9rem;
}

.status-present {
    background: rgba(0, 204, 102, 0.2);
    color: #00cc66;
    border-color: rgba(0, 204, 102, 0.3);
}

.status-present.active {
    background: rgba(0, 204, 102, 0.4);
    border-color: #00cc66;
    transform: scale(1.05);
}

.status-absent {
    background: rgba(255, 51, 102, 0.2);
    color: #ff3366;
    border-color: rgba(255, 51, 102, 0.3);
}

.status-absent.active {
    background: rgba(255, 51, 102, 0.4);
    border-color: #ff3366;
    transform: scale(1.05);
}

.status-late {
    background: rgba(255, 170, 0, 0.2);
    color: #ffaa00;
    border-color: rgba(255, 170, 0, 0.3);
}

.status-late.active {
    background: rgba(255, 170, 0, 0.4);
    border-color: #ffaa00;
    transform: scale(1.05);
}

.notes-input {
    width: 200px;
    background: rgba(0, 0, 0, 0.2);
    border: 2px solid var(--card-border);
    border-radius: 8px;
    padding: 8px 12px;
    color: var(--light);
    font-size: 0.9rem;
    transition: border-color 0.3s;
}

.notes-input:focus {
    outline: none;
    border-color: var(--primary);
}

.loading-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--gray);
}

.loading-state i {
    font-size: 3rem;
    margin-bottom: 15px;
    color: var(--primary);
    opacity: 0.5;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading-state h3 {
    color: var(--light);
    margin-bottom: 10px;
    font-size: 1.2rem;
}

.loading-state p {
    margin-bottom: 20px;
    font-size: 0.95rem;
}

.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--gray);
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 15px;
    color: var(--primary);
    opacity: 0.5;
}

.empty-state h3 {
    color: var(--light);
    margin-bottom: 10px;
    font-size: 1.2rem;
}

.empty-state p {
    margin-bottom: 20px;
    font-size: 0.95rem;
}

.stats-display {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    background: rgba(0, 212, 255, 0.05);
    border-radius: 12px;
    margin-bottom: 20px;
    border: 2px solid var(--card-border);
}

.stat-item {
    text-align: center;
}

.stat-value {
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--primary);
    line-height: 1;
    margin-bottom: 5px;
}

.stat-label {
    color: var(--light);
    font-size: 0.9rem;
    font-weight: 500;
}

.stat-rate {
    font-size: 1.5rem;
    font-weight: 700;
    background: linear-gradient(135deg, var(--accent), #00cc66);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.pdf-section {
    background: rgba(0, 212, 255, 0.05);
    border-radius: 12px;
    padding: 20px;
    margin-top: 20px;
    border: 2px solid var(--card-border);
    text-align: center;
}

.pdf-section h4 {
    color: var(--light);
    margin-bottom: 15px;
    font-size: 1.1rem;
}

.pdf-actions {
    display: flex;
    gap: 10px;
    justify-content: center;
    flex-wrap: wrap;
}

.recent-sessions {
    background: linear-gradient(135deg, rgba(20, 25, 50, 0.9), rgba(30, 35, 60, 0.9));
    border-radius: 15px;
    padding: 25px;
    border: 2px solid var(--card-border);
}

.recent-sessions h3 {
    font-size: 1.3rem;
    color: var(--light);
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.recent-sessions h3 i {
    color: var(--primary);
}

.sessions-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.session-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 10px;
    border: 1px solid var(--card-border);
    transition: all 0.3s;
}

.session-item:hover {
    border-color: var(--primary);
    transform: translateX(5px);
}

.session-date {
    color: var(--light);
    font-weight: 500;
    font-size: 0.95rem;
}

.session-details {
    color: var(--gray);
    font-size: 0.9rem;
    margin-top: 3px;
}

.session-actions {
    display: flex;
    gap: 8px;
}

.session-btn {
    padding: 5px 10px;
    border-radius: 6px;
    background: rgba(0, 212, 255, 0.1);
    color: var(--primary);
    text-decoration: none;
    font-size: 0.8rem;
    font-weight: 500;
    transition: all 0.3s;
}

.session-btn:hover {
    background: rgba(0, 212, 255, 0.2);
}

@media (max-width: 768px) {
    .attendance-header {
        flex-direction: column;
        align-items: stretch;
    }
    
    .header-left h1 {
        font-size: 1.7rem;
    }
    
    .attendance-form {
        padding: 20px;
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .student-card {
        flex-direction: column;
        align-items: stretch;
        text-align: center;
    }
    
    .student-avatar {
        align-self: center;
    }
    
    .attendance-actions {
        justify-content: center;
        margin-top: 10px;
    }
    
    .stats-display {
        flex-direction: column;
        gap: 15px;
        text-align: center;
    }
    
    .form-actions {
        flex-direction: column;
        gap: 15px;
    }
}

@media (max-width: 480px) {
    .attendance-container {
        padding: 15px;
    }
    
    .attendance-actions {
        flex-direction: column;
        align-items: stretch;
    }
    
    .status-btn {
        width: 100%;
    }
    
    .notes-input {
        width: 100%;
    }
    
    .pdf-actions {
        flex-direction: column;
    }
    
    .pdf-actions .btn {
        width: 100%;
        justify-content: center;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="attendance-container">
    <div class="attendance-header">
        <div class="header-left">
            <h1>Mark Attendance</h1>
            <p>Take attendance for your assigned classes and subjects</p>
        </div>
        
        {% if motivational_msg %}
        <div class="motivational-message">
            <i class="fas fa-sparkles"></i>
            <span>{{ motivational_msg }}</span>
        </div>
        {% endif %}
    </div>
    
    <div class="attendance-form">
        <div class="form-section">
            <h3 class="section-title">
                <i class="fas fa-cog"></i> Select Class & Subject
            </h3>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-chalkboard"></i> Select Class
                    </label>
                    <select id="classSelect" class="form-control" required>
                        <option value="">-- Select Class --</option>
                        {% for class_name, sections in assigned_classes.items() %}
                            {% for section in sections %}
                            <option value="{{ class_name }}_{{ section }}">
                                Class {{ class_name }}-{{ section }}
                            </option>
                            {% endfor %}
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-book"></i> Select Subject
                    </label>
                    <select id="subjectSelect" class="form-control" required disabled>
                        <option value="">-- Select Class First --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-calendar"></i> Date
                    </label>
                    <input type="date" id="dateSelect" class="form-control" value="{{ today }}" max="{{ today }}" required>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="button" id="loadStudentsBtn" class="btn-primary" disabled>
                    <i class="fas fa-users"></i> Load Students
                </button>
                
                <button type="button" id="checkAttendanceBtn" class="btn-secondary" disabled>
                    <i class="fas fa-search"></i> Check Previous Attendance
                </button>
            </div>
        </div>
        
        <div id="studentsSection" style="display: none;">
            <div class="form-section">
                <h3 class="section-title">
                    <i class="fas fa-user-graduate"></i> Mark Student Attendance
                </h3>
                
                <div id="studentsList" class="students-list">
                    <!-- Students will be loaded here -->
                </div>
                
                <div id="attendanceStats" class="stats-display" style="display: none;">
                    <div class="stat-item">
                        <div class="stat-value" id="totalStudents">0</div>
                        <div class="stat-label">Total Students</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="presentCount">0</div>
                        <div class="stat-label">Present</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="absentCount">0</div>
                        <div class="stat-label">Absent</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value stat-rate" id="attendanceRate">0%</div>
                        <div class="stat-label">Attendance Rate</div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" id="saveAttendanceBtn" class="btn-primary" disabled>
                        <i class="fas fa-save"></i> Save Attendance
                    </button>
                    
                    <button type="button" id="resetAttendanceBtn" class="btn-secondary">
                        <i class="fas fa-redo"></i> Reset All
                    </button>
                </div>
            </div>
        </div>
        
        <div id="pdfSection" class="pdf-section" style="display: none;">
            <h4>Attendance Saved Successfully!</h4>
            <p>You can now download the professional PDF report.</p>
            <div class="pdf-actions">
                <a href="#" id="downloadPdfBtn" class="btn-primary">
                    <i class="fas fa-download"></i> Download PDF Report
                </a>
                <a href="#" id="viewPdfBtn" class="btn-secondary">
                    <i class="fas fa-eye"></i> View in Browser
                </a>
                <a href="{{ url_for('attendance_history') }}" class="btn-secondary">
                    <i class="fas fa-history"></i> View History
                </a>
            </div>
        </div>
    </div>
    
    {% if recent_sessions %}
    <div class="recent-sessions">
        <h3>
            <i class="fas fa-history"></i> Recent Attendance Sessions
        </h3>
        <div class="sessions-list">
            {% for session in recent_sessions %}
            <div class="session-item">
                <div>
                    <div class="session-date">
                        {{ session.date.strftime('%d %b, %Y') }}
                    </div>
                    <div class="session-details">
                        Class {{ session.class_name }}-{{ session.section }} | 
                        {{ session.subject.name if session.subject else 'N/A' }}
                    </div>
                </div>
                <div class="session-actions">
                    <a href="{{ url_for('view_attendance_pdf', session_id=session.id) }}" 
                       class="session-btn" target="_blank" title="View PDF">
                        <i class="fas fa-file-pdf"></i> PDF
                    </a>
                    <a href="{{ url_for('download_attendance_pdf', 
                                       class_name=session.class_name, 
                                       section=session.section,
                                       date=session.date.strftime('%Y-%m-%d'),
                                       subject_id=session.subject_id) }}" 
                       class="session-btn" title="Download">
                        <i class="fas fa-download"></i>
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // DOM Elements
    const classSelect = document.getElementById('classSelect');
    const subjectSelect = document.getElementById('subjectSelect');
    const dateSelect = document.getElementById('dateSelect');
    const loadStudentsBtn = document.getElementById('loadStudentsBtn');
    const checkAttendanceBtn = document.getElementById('checkAttendanceBtn');
    const studentsSection = document.getElementById('studentsSection');
    const studentsList = document.getElementById('studentsList');
    const attendanceStats = document.getElementById('attendanceStats');
    const saveAttendanceBtn = document.getElementById('saveAttendanceBtn');
    const resetAttendanceBtn = document.getElementById('resetAttendanceBtn');
    const pdfSection = document.getElementById('pdfSection');
    const downloadPdfBtn = document.getElementById('downloadPdfBtn');
    const viewPdfBtn = document.getElementById('viewPdfBtn');
    
    // State variables
    let currentClass = '';
    let currentSection = '';
    let currentSubjectId = '';
    let currentDate = '';
    let students = [];
    let attendanceData = {};
    let attendanceSessionId = null;
    
    // Initialize date to today
    const today = new Date().toISOString().split('T')[0];
    dateSelect.value = today;
    dateSelect.max = today;
    
    // Load subjects when class is selected
    classSelect.addEventListener('change', function() {
        const value = this.value;
        if (!value) {
            subjectSelect.innerHTML = '<option value="">-- Select Class First --</option>';
            subjectSelect.disabled = true;
            loadStudentsBtn.disabled = true;
            checkAttendanceBtn.disabled = true;
            return;
        }
        
        const [class_name, section] = value.split('_');
        currentClass = class_name;
        currentSection = section;
        
        // Enable buttons
        loadStudentsBtn.disabled = false;
        checkAttendanceBtn.disabled = false;
        
        // Clear and disable subject select
        subjectSelect.innerHTML = '<option value="">Loading subjects...</option>';
        subjectSelect.disabled = true;
        
        // Fetch subjects for this class
        fetch(`/api/subjects/${class_name}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    subjectSelect.innerHTML = `<option value="">Error: ${data.error}</option>`;
                    return;
                }
                
                subjectSelect.innerHTML = '<option value="">-- Select Subject --</option>';
                data.subjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject.id;
                    option.textContent = subject.name;
                    subjectSelect.appendChild(option);
                });
                
                subjectSelect.disabled = false;
            })
            .catch(error => {
                console.error('Error loading subjects:', error);
                subjectSelect.innerHTML = '<option value="">Error loading subjects</option>';
            });
    });
    
    // Update subject ID when selected
    subjectSelect.addEventListener('change', function() {
        currentSubjectId = this.value;
    });
    
    // Update date when changed
    dateSelect.addEventListener('change', function() {
        currentDate = this.value;
    });
    
    // Load students button click
    loadStudentsBtn.addEventListener('click', function() {
        if (!currentClass || !currentSection || !currentSubjectId || !dateSelect.value) {
            alert('Please select class, subject, and date');
            return;
        }
        
        currentDate = dateSelect.value;
        
        // Show loading state
        studentsList.innerHTML = `
            <div class="loading-state">
                <i class="fas fa-spinner"></i>
                <h3>Loading Students</h3>
                <p>Please wait while we load the student list...</p>
            </div>
        `;
        
        studentsSection.style.display = 'block';
        attendanceStats.style.display = 'none';
        saveAttendanceBtn.disabled = true;
        
        // Fetch students
        fetch(`/api/students/${currentClass}/${currentSection}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    studentsList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h3>Error Loading Students</h3>
                            <p>${data.error}</p>
                        </div>
                    `;
                    return;
                }
                
                students = data.students;
                attendanceData = {};
                
                if (students.length === 0) {
                    studentsList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-user-graduate"></i>
                            <h3>No Students Found</h3>
                            <p>No active students found in this class.</p>
                        </div>
                    `;
                    return;
                }
                
                // Render students
                renderStudentsList();
                
                // Check for existing attendance
                checkExistingAttendance();
            })
            .catch(error => {
                console.error('Error loading students:', error);
                studentsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Error Loading Students</h3>
                        <p>Failed to load student data. Please try again.</p>
                    </div>
                `;
            });
    });
    
    // Check previous attendance button
    checkAttendanceBtn.addEventListener('click', function() {
        if (!currentClass || !currentSection || !currentSubjectId || !dateSelect.value) {
            alert('Please select class, subject, and date');
            return;
        }
        
        currentDate = dateSelect.value;
        
        fetch(`/api/attendance/check/${currentDate}/${currentClass}/${currentSection}/${currentSubjectId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error checking attendance: ' + data.error);
                    return;
                }
                
                if (data.exists) {
                    const confirmed = confirm(
                        `Attendance already exists for ${currentDate}.\n` +
                        `Present: ${data.stats.present}, Absent: ${data.stats.absent}\n\n` +
                        'Do you want to load and edit it?'
                    );
                    
                    if (confirmed) {
                        // Load the existing attendance
                        attendanceSessionId = data.session_id;
                        attendanceData = {};
                        
                        data.attendance.forEach(item => {
                            attendanceData[item.student_id] = {
                                status: item.status,
                                notes: item.notes
                            };
                        });
                        
                        // Load students and apply existing attendance
                        loadStudentsBtn.click();
                    }
                } else {
                    alert('No attendance found for the selected date.');
                }
            })
            .catch(error => {
                console.error('Error checking attendance:', error);
                alert('Failed to check attendance. Please try again.');
            });
    });
    
    // Render students list
    function renderStudentsList() {
        studentsList.innerHTML = '';
        
        students.forEach(student => {
            const studentData = attendanceData[student.id] || { status: 'present', notes: '' };
            
            const studentCard = document.createElement('div');
            studentCard.className = 'student-card';
            studentCard.dataset.studentId = student.id;
            
            studentCard.innerHTML = `
                <div class="student-avatar">
                    ${student.photo_url ? 
                        `<img src="${student.photo_url}" alt="${student.name}" onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\\'default-avatar\\'><i class=\\"fas fa-user\\"></i></div>';">` :
                        `<div class="default-avatar"><i class="fas fa-user"></i></div>`
                    }
                </div>
                <div class="student-info">
                    <div class="student-name">${student.name}</div>
                    <div class="student-details">
                        <span><i class="fas fa-hashtag"></i> Roll: ${student.roll_number}</span>
                        <span><i class="fas fa-phone"></i> ${student.father_phone}</span>
                    </div>
                </div>
                <div class="attendance-actions">
                    <button type="button" class="status-btn status-present ${studentData.status === 'present' ? 'active' : ''}" 
                            data-status="present" data-student-id="${student.id}">
                        <i class="fas fa-check"></i> Present
                    </button>
                    <button type="button" class="status-btn status-absent ${studentData.status === 'absent' ? 'active' : ''}" 
                            data-status="absent" data-student-id="${student.id}">
                        <i class="fas fa-times"></i> Absent
                    </button>
                    <button type="button" class="status-btn status-late ${studentData.status === 'late' ? 'active' : ''}" 
                            data-status="late" data-student-id="${student.id}">
                        <i class="fas fa-clock"></i> Late
                    </button>
                    <input type="text" class="notes-input" placeholder="Notes..." 
                           value="${studentData.notes}" 
                           data-student-id="${student.id}">
                </div>
            `;
            
            studentsList.appendChild(studentCard);
        });
        
        // Add event listeners to status buttons
        document.querySelectorAll('.status-btn').forEach(button => {
            button.addEventListener('click', function() {
                const studentId = this.dataset.studentId;
                const status = this.dataset.status;
                
                // Update active state
                this.parentElement.querySelectorAll('.status-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                this.classList.add('active');
                
                // Update attendance data
                if (!attendanceData[studentId]) {
                    attendanceData[studentId] = { status: status, notes: '' };
                } else {
                    attendanceData[studentId].status = status;
                }
                
                // Update stats
                updateAttendanceStats();
            });
        });
        
        // Add event listeners to notes inputs
        document.querySelectorAll('.notes-input').forEach(input => {
            input.addEventListener('input', function() {
                const studentId = this.dataset.studentId;
                if (!attendanceData[studentId]) {
                    attendanceData[studentId] = { status: 'present', notes: this.value };
                } else {
                    attendanceData[studentId].notes = this.value;
                }
            });
        });
        
        // Update stats
        updateAttendanceStats();
        attendanceStats.style.display = 'flex';
        saveAttendanceBtn.disabled = false;
    }
    
    // Update attendance statistics
    function updateAttendanceStats() {
        let present = 0;
        let absent = 0;
        let late = 0;
        
        students.forEach(student => {
            const data = attendanceData[student.id] || { status: 'present' };
            if (data.status === 'present') present++;
            else if (data.status === 'absent') absent++;
            else if (data.status === 'late') late++;
        });
        
        const total = students.length;
        const rate = total > 0 ? ((present / total) * 100).toFixed(1) : 0;
        
        document.getElementById('totalStudents').textContent = total;
        document.getElementById('presentCount').textContent = present;
        document.getElementById('absentCount').textContent = absent + late;
        document.getElementById('attendanceRate').textContent = rate + '%';
    }
    
    // Save attendance button click
    saveAttendanceBtn.addEventListener('click', function() {
        if (students.length === 0) {
            alert('No students to save attendance for');
            return;
        }
        
        // Prepare attendance data
        const attendance = [];
        students.forEach(student => {
            const data = attendanceData[student.id] || { status: 'present', notes: '' };
            attendance.push({
                student_id: student.id,
                status: data.status,
                notes: data.notes
            });
        });
        
        // Prepare request data
        const requestData = {
            class_name: currentClass,
            section: currentSection,
            subject_id: currentSubjectId,
            date: currentDate,
            attendance: attendance
        };
        
        // Disable button and show loading
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        
        // Send request
        fetch('/attendance/take', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                showSuccessMessage(data);
            } else {
                alert('Error saving attendance: ' + data.error);
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-save"></i> Save Attendance';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to save attendance. Please try again.');
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-save"></i> Save Attendance';
        });
    });
    
    // Show success message and PDF options
    function showSuccessMessage(data) {
        // Hide students section
        studentsSection.style.display = 'none';
        
        // Show PDF section
        pdfSection.style.display = 'block';
        
        // Update PDF links if available
        if (data.pdf_download_url) {
            downloadPdfBtn.href = data.pdf_download_url;
            downloadPdfBtn.style.display = 'inline-flex';
        } else {
            downloadPdfBtn.style.display = 'none';
        }
        
        if (data.pdf_url) {
            viewPdfBtn.href = data.pdf_url;
            viewPdfBtn.style.display = 'inline-flex';
        } else {
            viewPdfBtn.style.display = 'none';
        }
        
        // Show success notification
        const message = `âœ… ${data.message}\nðŸ“Š Stats: ${data.stats.present} present, ${data.stats.absent} absent (${data.stats.rate} attendance rate)`;
        alert(message);
    }
    
    // Reset attendance button
    resetAttendanceBtn.addEventListener('click', function() {
        if (confirm('Are you sure you want to reset all attendance? This cannot be undone.')) {
            attendanceData = {};
            if (students.length > 0) {
                renderStudentsList();
            }
        }
    });
    
    // Initialize date
    currentDate = dateSelect.value;
});
</script>
{% endblock %}