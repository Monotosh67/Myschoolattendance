{% extends "base.html" %}

{% block title %}Take Attendance - Dewra School{% endblock %}

{% block extra_css %}
<style>
    .student-list {
        max-height: 500px;
        overflow-y: auto;
    }
    .attendance-status {
        cursor: pointer;
    }
    .present {
        background-color: #d4edda !important;
    }
    .absent {
        background-color: #f8d7da !important;
    }
    .selected {
        border-left: 4px solid #0d6efd !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col">
            <h2><i class="bi bi-clipboard-check"></i> Take Attendance</h2>
            <p class="text-muted">{{ motivational_msg }}</p>
        </div>
    </div>

    <div class="row">
        <!-- Selection Panel -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-gear"></i> Select Class & Subject</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Class</label>
                        <select class="form-select" id="classSelect">
                            <option value="">Select Class</option>
                            {% for class_name, sections in assigned_classes.items() %}
                            <option value="{{ class_name }}">Class {{ class_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Section</label>
                        <select class="form-select" id="sectionSelect" disabled>
                            <option value="">Select Section</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Subject</label>
                        <select class="form-select" id="subjectSelect" disabled>
                            <option value="">Select Subject</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-control" id="dateSelect" value="{{ today }}">
                    </div>
                    
                    <button class="btn btn-primary w-100" id="loadStudentsBtn" disabled>
                        <i class="bi bi-people"></i> Load Students
                    </button>
                </div>
            </div>
            
            {% if recent_sessions %}
            <div class="card mt-3">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="bi bi-clock-history"></i> Recent Sessions</h6>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        {% for session in recent_sessions %}
                        <a href="#" class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">Class {{ session.class_name }}-{{ session.section }}</h6>
                                <small>{{ session.date.strftime('%d/%m') }}</small>
                            </div>
                            <p class="mb-1">{{ session.subject.name if session.subject else 'N/A' }}</p>
                            <small>{{ session.present_count }} Present, {{ session.absent_count }} Absent</small>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Attendance Panel -->
        <div class="col-md-9">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-clipboard-data"></i> Mark Attendance</h5>
                        <div id="summaryBadge" class="d-none">
                            <span class="badge bg-light text-dark">
                                <span id="presentCount">0</span> Present | 
                                <span id="absentCount">0</span> Absent
                            </span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="loadingStudents" class="text-center d-none">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading students...</p>
                    </div>
                    
                    <div id="noSelection" class="text-center text-muted py-5">
                        <i class="bi bi-people display-1"></i>
                        <h4 class="mt-3">Select a class and subject to begin</h4>
                        <p>Choose from the options on the left to load students</p>
                    </div>
                    
                    <div id="attendancePanel" class="d-none">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> Click on student rows to toggle attendance status. Green = Present, Red = Absent.
                        </div>
                        
                        <div class="table-responsive student-list">
                            <table class="table table-hover" id="studentsTable">
                                <thead class="table-light">
                                    <tr>
                                        <th width="5%">#</th>
                                        <th width="10%">Roll No</th>
                                        <th width="25%">Student Name</th>
                                        <th width="25%">Father's Name</th>
                                        <th width="15%">Contact</th>
                                        <th width="10%">Status</th>
                                        <th width="10%">Remarks</th>
                                    </tr>
                                </thead>
                                <tbody id="studentsBody">
                                    <!-- Students will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <button class="btn btn-outline-secondary" id="markAllPresent">
                                        <i class="bi bi-check-circle"></i> Mark All Present
                                    </button>
                                    <button class="btn btn-outline-secondary ms-2" id="markAllAbsent">
                                        <i class="bi bi-x-circle"></i> Mark All Absent
                                    </button>
                                </div>
                                <div>
                                    <button class="btn btn-success" id="saveAttendanceBtn">
                                        <i class="bi bi-save"></i> Save Attendance
                                    </button>
                                    <button class="btn btn-primary ms-2" id="saveAndSMSBtn">
                                        <i class="bi bi-send"></i> Save & Send SMS
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="resultAlert" class="mt-3 d-none"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentClass = '';
    let currentSection = '';
    let currentSubject = '';
    let currentDate = '';
    let students = [];
    
    // Populate sections when class is selected
    document.getElementById('classSelect').addEventListener('change', function() {
        const classSelect = document.getElementById('classSelect');
        const sectionSelect = document.getElementById('sectionSelect');
        const subjectSelect = document.getElementById('subjectSelect');
        const loadBtn = document.getElementById('loadStudentsBtn');
        
        if (classSelect.value) {
            const className = classSelect.value;
            {% for class_name, sections in assigned_classes.items() %}
            if ('{{ class_name }}' === className) {
                sectionSelect.innerHTML = '<option value="">Select Section</option>';
                {% for section in sections %}
                sectionSelect.innerHTML += `<option value="{{ section }}">Section {{ section }}</option>`;
                {% endfor %}
                sectionSelect.disabled = false;
                
                // Populate subjects
                subjectSelect.innerHTML = '<option value="">Select Subject</option>';
                {% if class_subjects %}
                const subjects = {{ class_subjects|tojson|safe }};
                if (subjects[className]) {
                    subjects[className].forEach(subject => {
                        subjectSelect.innerHTML += `<option value="${subject.id}">${subject.name}</option>`;
                    });
                }
                {% endif %}
                subjectSelect.disabled = false;
            }
            {% endfor %}
            loadBtn.disabled = true;
        } else {
            sectionSelect.innerHTML = '<option value="">Select Section</option>';
            sectionSelect.disabled = true;
            subjectSelect.innerHTML = '<option value="">Select Subject</option>';
            subjectSelect.disabled = true;
            loadBtn.disabled = true;
        }
    });
    
    // Enable load button when all selections are made
    document.getElementById('sectionSelect').addEventListener('change', checkSelections);
    document.getElementById('subjectSelect').addEventListener('change', checkSelections);
    
    function checkSelections() {
        const classVal = document.getElementById('classSelect').value;
        const sectionVal = document.getElementById('sectionSelect').value;
        const subjectVal = document.getElementById('subjectSelect').value;
        const dateVal = document.getElementById('dateSelect').value;
        const loadBtn = document.getElementById('loadStudentsBtn');
        
        if (classVal && sectionVal && subjectVal && dateVal) {
            loadBtn.disabled = false;
        } else {
            loadBtn.disabled = true;
        }
    }
    
    // Load students
    document.getElementById('loadStudentsBtn').addEventListener('click', function() {
        currentClass = document.getElementById('classSelect').value;
        currentSection = document.getElementById('sectionSelect').value;
        currentSubject = document.getElementById('subjectSelect').value;
        currentDate = document.getElementById('dateSelect').value;
        
        loadStudents();
    });
    
    function loadStudents() {
        document.getElementById('noSelection').classList.add('d-none');
        document.getElementById('attendancePanel').classList.add('d-none');
        document.getElementById('loadingStudents').classList.remove('d-none');
        
        // Check existing attendance first
        fetch(`/api/check-attendance/${currentClass}/${currentSection}/${currentSubject}/${currentDate}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.exists) {
                        // Load existing attendance
                        displayStudents(data.attendance);
                    } else {
                        // Load fresh student list
                        fetch(`/api/students/${currentClass}/${currentSection}`)
                            .then(response => response.json())
                            .then(studentData => {
                                if (studentData.success) {
                                    displayStudents(studentData.students.map(s => ({
                                        ...s,
                                        status: 'absent',
                                        notes: ''
                                    })));
                                } else {
                                    showError('Failed to load students');
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                showError('Error loading students');
                            });
                    }
                } else {
                    showError(data.error || 'Error checking attendance');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError('Error checking attendance');
            });
    }
    
    function displayStudents(studentList) {
        students = studentList;
        const tbody = document.getElementById('studentsBody');
        tbody.innerHTML = '';
        
        studentList.forEach((student, index) => {
            const row = document.createElement('tr');
            row.className = `attendance-status ${student.status}`;
            row.dataset.studentId = student.id;
            row.dataset.status = student.status;
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${student.roll_number}</td>
                <td>${student.name}</td>
                <td>${student.father_name || 'N/A'}</td>
                <td>${student.father_phone || student.mother_phone || 'N/A'}</td>
                <td>
                    <span class="badge ${student.status === 'present' ? 'bg-success' : 'bg-danger'}">
                        ${student.status === 'present' ? 'Present' : 'Absent'}
                    </span>
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm remarks-input" 
                           value="${student.notes || ''}" 
                           placeholder="Remarks" 
                           data-student-id="${student.id}">
                </td>
            `;
            tbody.appendChild(row);
        });
        
        // Add click handlers
        document.querySelectorAll('.attendance-status').forEach(row => {
            row.addEventListener('click', function(e) {
                if (!e.target.classList.contains('remarks-input')) {
                    toggleAttendance(this);
                }
            });
        });
        
        // Add input handlers for remarks
        document.querySelectorAll('.remarks-input').forEach(input => {
            input.addEventListener('change', function() {
                const studentId = parseInt(this.dataset.studentId);
                const student = students.find(s => s.id === studentId);
                if (student) {
                    student.notes = this.value;
                }
            });
        });
        
        document.getElementById('loadingStudents').classList.add('d-none');
        document.getElementById('attendancePanel').classList.remove('d-none');
        document.getElementById('summaryBadge').classList.remove('d-none');
        updateSummary();
    }
    
    function toggleAttendance(row) {
        const studentId = parseInt(row.dataset.studentId);
        const currentStatus = row.dataset.status;
        const newStatus = currentStatus === 'present' ? 'absent' : 'present';
        
        row.dataset.status = newStatus;
        row.className = `attendance-status ${newStatus}`;
        
        const badge = row.querySelector('.badge');
        badge.className = newStatus === 'present' ? 'badge bg-success' : 'badge bg-danger';
        badge.textContent = newStatus === 'present' ? 'Present' : 'Absent';
        
        // Update student object
        const student = students.find(s => s.id === studentId);
        if (student) {
            student.status = newStatus;
        }
        
        updateSummary();
    }
    
    function updateSummary() {
        const presentCount = students.filter(s => s.status === 'present').length;
        const absentCount = students.length - presentCount;
        
        document.getElementById('presentCount').textContent = presentCount;
        document.getElementById('absentCount').textContent = absentCount;
    }
    
    // Mark all buttons
    document.getElementById('markAllPresent').addEventListener('click', function() {
        document.querySelectorAll('.attendance-status').forEach(row => {
            if (row.dataset.status !== 'present') {
                toggleAttendance(row);
            }
        });
    });
    
    document.getElementById('markAllAbsent').addEventListener('click', function() {
        document.querySelectorAll('.attendance-status').forEach(row => {
            if (row.dataset.status !== 'absent') {
                toggleAttendance(row);
            }
        });
    });
    
    // Save attendance
    document.getElementById('saveAttendanceBtn').addEventListener('click', function() {
        saveAttendance(false);
    });
    
    document.getElementById('saveAndSMSBtn').addEventListener('click', function() {
        saveAttendance(true);
    });
    
    function saveAttendance(sendSMS) {
        const attendanceData = students.map(student => ({
            student_id: student.id,
            status: student.status,
            notes: student.notes || ''
        }));
        
        const payload = {
            class_name: currentClass,
            section: currentSection,
            subject_id: parseInt(currentSubject),
            date: currentDate,
            attendance: attendanceData
        };
        
        const saveBtn = document.getElementById('saveAttendanceBtn');
        const smsBtn = document.getElementById('saveAndSMSBtn');
        const originalText = saveBtn.innerHTML;
        
        saveBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Saving...';
        saveBtn.disabled = true;
        smsBtn.disabled = true;
        
        fetch('/attendance/take', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess(data.message + (sendSMS ? ' SMS will be sent shortly.' : ''));
                
                if (data.pdf_url) {
                    const pdfLink = document.createElement('a');
                    pdfLink.href = data.pdf_download_url;
                    pdfLink.className = 'btn btn-outline-primary btn-sm ms-2';
                    pdfLink.innerHTML = '<i class="bi bi-download"></i> Download PDF';
                    pdfLink.target = '_blank';
                    document.getElementById('resultAlert').appendChild(pdfLink);
                }
            } else {
                showError(data.error || 'Failed to save attendance');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('Error saving attendance');
        })
        .finally(() => {
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
            smsBtn.disabled = false;
        });
    }
    
    function showSuccess(message) {
        const alertDiv = document.getElementById('resultAlert');
        alertDiv.className = 'alert alert-success d-flex align-items-center';
        alertDiv.innerHTML = `
            <i class="bi bi-check-circle-fill me-2"></i>
            <div>${message}</div>
        `;
        alertDiv.classList.remove('d-none');
        
        // Auto hide after 5 seconds
        setTimeout(() => {
            alertDiv.classList.add('d-none');
        }, 5000);
    }
    
    function showError(message) {
        const alertDiv = document.getElementById('resultAlert');
        alertDiv.className = 'alert alert-danger d-flex align-items-center';
        alertDiv.innerHTML = `
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <div>${message}</div>
        `;
        alertDiv.classList.remove('d-none');
    }
    
    // Initialize date to today
    document.getElementById('dateSelect').value = '{{ today }}';
</script>
{% endblock %}